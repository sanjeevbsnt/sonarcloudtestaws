version: 0.2

phases:
    install:
        runtime-versions:
            python: 3.11
        commands:
            - pip3 install -q awscli --upgrade --user
            - pip3 install boto3
            - yum -q install -y zip
            - yum -q install -y jq # Install zip utility
            - wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-10.0.0.1189-linux.zip -O /tmp/sonar-scanner.zip  # Download SonarScanner
            - unzip -q /tmp/sonar-scanner.zip -d /opt/sonar-scanner  # Unzip SonarScanner
    pre_build:
        commands:
            - echo Start code scan...
            - /opt/sonar-scanner/sonar-scanner-10.0.0.1189-linux/bin/sonar-scanner -Dsonar.projectKey=$SONAR_QUBE_PROJECT -Dsonar.sources=. -Dsonar.host.url=$SONAR_QUBE_URL -Dsonar.login=$SONAR_QUBE_KEY
            - sleep 7
            - "curl -s -u $SONAR_QUBE_KEY: $SONAR_QUBE_URL/api/qualitygates/project_status?projectKey=$SONAR_QUBE_PROJECT> /tmp/result.json"
            - if [ "$(jq -r '.projectStatus.status' /tmp/result.json)" = "ERROR" ]; then CODEBUILD_BUILD_SUCCEEDING=0; fi
            - echo Code scan completed on $(date)
            - if [ "$CODEBUILD_BUILD_SUCCEEDING" -eq 0 ]; then exit 1; fi




















